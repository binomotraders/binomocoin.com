
var options = "";
$.ajaxSetup({
    headers: {
        "X-CSRF-TOKEN": $('meta[name="csrf-token"]').attr("content"),
    },
});

$("#formPreviewBuy").submit(function (e) {
    e.preventDefault();
    if ($(this).valid()) {
        $(this).find("button[type=submit]").prop("disabled", true);

        const BNCqtyByUser = $("#noBNCToBuy").val();

        fetchCurrentBncValue(BNCqtyByUser);        
    } else {
        $(this).find("button[type=submit]").prop("disabled", false);
    }
});

const fetchCurrentBncValue = (BNCqtyByUser) => {
    $.ajax({
        url: "/getbncvalue/" + BNCqtyByUser,
        type: "GET",
        contentType: "application/json",
        success: function (result) {
            if (result.status === "success") {
                options = result.order;
                let payAmount = result.payAmount;
                payAmount = new Intl.NumberFormat("en-IN").format(payAmount);

                $("#lblInrPayAmount").html(payAmount);
                $("#lblBNCtoBuy").html(BNCqtyByUser);
                $("#buyBNCModalFirst").modal("hide");
                clearPopModalFirst();

                $("#buyBNCModalSecond").modal({
                    backdrop: "static",
                    datakeyboard: false,
                    show: true,
                });
            } else {
                alert("505 | Fetch BNC value error, Please contact admin...!");
            }
        },
    });
    return;
};

$("#formConfirmBuy").submit(function (e) {
    e.preventDefault();
    if ($(this).valid()) {
        $(this).find("button[type=submit]").prop("disabled", true);

        $("#buyBNCModalSecond").modal("hide");
        openCheckout();
    } else {
        $(this).find("button[type=submit]").prop("disabled", false);
    }
});

const openCheckout = () => {
    try {
        const base_url = window.location.origin;
        const logo_path = base_url + "/wallet/images/binomo-text-dark.png";

        const orderObj = {
            key: options.key,
            amount: options.amount,
            currency: options.currency,
            order_id: options.order_id,
            name: "Binomo Coin",
            description: "Purchased BNC of INR "+ (options.amount/100),
            image: logo_path,
            handler: async (response) => {
                // location.reload();
                updatePayment(response);
            },
            prefill: {
                name: options.name,
                email: options.email
            },
            readonly: { name: true, email: true },
            notes: {
                address: "Binomo Traders Corporate Office",
            },
            theme: {
                color: "#08C8F6",
            },
            method: {
                upi: true,
                card: true,
                wallet: true,
                netbanking: true,
            },
        };
        
        const rzp1 = new Razorpay(orderObj);
        rzp1.open();
        $("#waitingModal").modal({
            backdrop: "static",
            datakeyboard: false,
            show: true,
        });
        clearPopModalSecond();
    } catch (error) {
        alert("505 | Checkout page error, Please contact admin...!");
    }
};

const clearPopModalFirst = () => {
    $("#noBNCToBuy").val('');
    $("#btnPrvBuy").prop("disabled", false);
}

const clearPopModalSecond = () => {
    $("#btnConfirmBuy").prop("disabled", false);
    $("#lblInrPayAmount").html("");
    $("#lblBNCtoBuy").html("");
};

const updatePayment = (paymentData) => {
    paymentData['order_obj']=options;
    
    $.ajax({
        url: "/update/payment/status",
        type: "POST",
        data: JSON.stringify(paymentData),
        contentType: "application/json",
        success: function (data) {
            $("#paymentTransactionID").html(data.paymentReceipt);
            $("#waitingModal").modal("hide");
            $("#paymentUpdateStatusModal").modal({
                backdrop: "static",
                datakeyboard: false,
                show: true,
            });
        },
    });
    return;
};

$("#showWalletAddress").click(function () {
    $("#walletAddress").removeClass("display-none");
});